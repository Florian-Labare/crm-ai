# Pas besoin de "version" avec Docker Compose v2+

services:
  # --- BACKEND (Laravel) ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: laravel_app
    restart: unless-stopped

    # Monter le code source + le .env spécifique du backend
    volumes:
      - ./backend:/var/www/html
      - ./backend/.env:/var/www/html/.env

    ports:
      - "${APP_PORT:-8000}:80"

    # Variables d'environnement nécessaires à Laravel
    environment:
      APP_ENV: ${APP_ENV:-local}
      APP_DEBUG: ${APP_DEBUG:-true}
      APP_KEY: ${APP_KEY}
      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:-crm_ai}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
      CACHE_STORE: ${CACHE_STORE:-redis}
      TRANSCRIPTION_MODE: ${TRANSCRIPTION_MODE:-openai}

    depends_on:
      - db
      - redis

  # --- BASE DE DONNÉES ---
  db:
    image: mariadb:11
    container_name: mariadb_db
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:-root}
      MARIADB_DATABASE: ${MARIADB_DATABASE:-crm_ai}
      MARIADB_USER: ${MARIADB_USER:-root}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD:-root}
    ports:
      - "3307:3306"
    volumes:
      - mariadb_data:/var/lib/mysql

  # --- REDIS (Cache & Queues) ---
  redis:
    image: redis:7-alpine
    container_name: redis_cache
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # --- PHPMYADMIN ---
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadmin
    restart: always
    ports:
      - "${PMA_PORT:-8080}:80"
    environment:
      PMA_HOST: db
      PMA_USER: ${MARIADB_USER:-root}
      PMA_PASSWORD: ${MARIADB_PASSWORD:-root}
      UPLOAD_LIMIT: 100M
    depends_on:
      - db

  # --- QUEUE WORKER (Traitement asynchrone) ---
  queue-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: laravel_queue_worker
    restart: unless-stopped

    # Même configuration que le backend
    volumes:
      - ./backend:/var/www/html
      - ./backend/.env:/var/www/html/.env

    # Variables d'environnement identiques au backend
    environment:
      APP_ENV: ${APP_ENV:-local}
      APP_DEBUG: ${APP_DEBUG:-true}
      APP_KEY: ${APP_KEY}
      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:-crm_ai}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
      CACHE_STORE: ${CACHE_STORE:-redis}
      TRANSCRIPTION_MODE: ${TRANSCRIPTION_MODE:-openai}

    # Lancer le queue worker au démarrage (avec redis)
    command: sh -c "sleep 5 && php artisan queue:work redis --verbose --tries=3 --timeout=300"

    depends_on:
      backend:
        condition: service_started
      db:
        condition: service_started
      redis:
        condition: service_healthy

  # --- MAILHOG (Serveur SMTP pour tests emails) ---
  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    logging:
      driver: 'none'  # Désactive les logs pour réduire le bruit

  # --- GOTENBERG (Conversion documents → PDF) ---
  gotenberg:
    image: gotenberg/gotenberg:8
    container_name: gotenberg
    restart: unless-stopped
    ports:
      - "3001:3000"  # API HTTP pour conversion
    environment:
      DISABLE_GOOGLE_CHROME: "1"  # On utilise seulement LibreOffice
      DEFAULT_WAIT_TIMEOUT: "30"
    command:
      - "gotenberg"
      - "--api-timeout=30s"
      - "--api-port=3000"
      - "--log-level=info"

  # --- FRONTEND (Vite/React/Vue/Autre) ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: crm_ai_frontend
    restart: unless-stopped
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:${APP_PORT:-8000}/api
      VITE_API_KEY: la-guigz-key
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173"]
    depends_on:
      - backend

# --- VOLUMES ---
volumes:
  mariadb_data:
  redis_data:
